name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ ãƒ†ã‚¹ãƒˆ
  frontend-test:
    name: ğŸ”µ Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          # Worktreeå¯¾å¿œ: å±¥æ­´ã‚’å–å¾—ã—ã¦ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’å®Œå…¨ã«ã™ã‚‹
          fetch-depth: 0
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci
        
      - name: ğŸ§ª Run tests
        working-directory: ./frontend
        run: npm test -- --coverage --watchAll=false
        
      - name: ğŸ—ï¸ Build frontend
        working-directory: ./frontend
        run: npm run build
        
      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v5
        with:
          file: ./frontend/coverage/lcov.info
          flags: frontend

  # Docker Compose ãƒ†ã‚¹ãƒˆ
  docker-test:
    name: ğŸ³ Docker Compose Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ—ï¸ Build services
        run: docker compose build --no-cache
        
      - name: ğŸš€ Start services
        run: docker compose up -d
        
      - name: â³ Wait for services
        run: |
          echo "Waiting for services to be ready..."
          timeout 300 bash -c 'until curl -f http://localhost:3001 &>/dev/null; do sleep 5; done'
          timeout 300 bash -c 'until curl -f http://localhost:9003 &>/dev/null; do sleep 5; done'
          
      - name: ğŸ§ª Test service connectivity
        run: |
          # Frontend test
          curl -f http://localhost:3001 || exit 1
          echo "âœ… Frontend service is running"
          
          # MinIO test
          curl -f http://localhost:9003 || exit 1
          echo "âœ… MinIO service is running"
          
          # MySQL test
          docker compose exec -T db mysql -u myapp -pmyapp_pass -e "SELECT 1;" || exit 1
          echo "âœ… MySQL service is running"
          
          # Worktree compatibility check
          if [ -f .git ] && grep -q "gitdir:" .git; then
            echo "ğŸŒ³ Worktree setup detected"
            git worktree list || echo "âš ï¸  Not in worktree environment"
          fi
          
      - name: ğŸ“‹ Show service status
        run: docker compose ps
        
      - name: ğŸ“œ Show logs on failure
        if: failure()
        run: docker compose logs
        
      - name: ğŸ›‘ Stop services
        if: always()
        run: docker compose down -v

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ãƒ†ã‚¹ãƒˆï¼ˆå°†æ¥å®Ÿè£…äºˆå®šï¼‰
  backend-test:
    name: ğŸ”´ Backend Tests (Future)
    runs-on: ubuntu-latest
    if: false  # ç¾åœ¨ã¯ç„¡åŠ¹åŒ–
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2
          bundler-cache: true
          working-directory: ./backend
          
      - name: ğŸ—„ï¸ Setup database
        working-directory: ./backend
        run: |
          bundle exec rails db:setup
          bundle exec rails db:migrate
          
      - name: ğŸ§ª Run tests
        working-directory: ./backend
        run: bundle exec rspec

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & å“è³ªãƒã‚§ãƒƒã‚¯
  security-check:
    name: ğŸ”’ Security & Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: ğŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: ğŸŸ¢ Setup Node.js for linting
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
        
      - name: ğŸ¨ Run ESLint
        working-directory: ./frontend
        run: npm run lint || echo "ESLint not configured yet"

  # ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmain ãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [frontend-test, docker-test, security-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Build for production
        run: |
          echo "ğŸ—ï¸ Building production images..."
          docker compose -f docker-compose.yml -f docker-compose.prod.yml build
          
      - name: ğŸ“¦ Tag images
        run: |
          echo "ğŸ“¦ Tagging images for deployment..."
          docker tag myapp-frontend:latest myapp-frontend:${{ github.sha }}
          
      - name: ğŸ‰ Deployment ready
        run: |
          echo "ğŸ‰ Deployment ready!"
          echo "Images tagged with SHA: ${{ github.sha }}"

  # é€šçŸ¥
  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [frontend-test, docker-test, security-check]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notify success
        if: needs.frontend-test.result == 'success' && needs.docker-test.result == 'success'
        run: |
          echo "âœ… All tests passed!"
          echo "Frontend: ${{ needs.frontend-test.result }}"
          echo "Docker: ${{ needs.docker-test.result }}"
          echo "Security: ${{ needs.security-check.result }}"
          
      - name: ğŸ“¢ Notify failure
        if: needs.frontend-test.result == 'failure' || needs.docker-test.result == 'failure'
        run: |
          echo "âŒ Some tests failed!"
          echo "Frontend: ${{ needs.frontend-test.result }}"
          echo "Docker: ${{ needs.docker-test.result }}"
          echo "Security: ${{ needs.security-check.result }}"